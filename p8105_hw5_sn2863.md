Homework 5 - Iteration
================
Sydney Ng (uni: sn2863)
Due 11/18/2020 by 10:00 pm ET

### Problem 1

``` r
homicide_df <-
  read_csv("./homicide-data.csv") %>%
  mutate(
    city_state = str_c(city, state, sep = "_"),
    resolved = case_when(
      disposition == "Closed without arrest" ~ "Unsolved",
      disposition == "Open/No arrest" ~ "Unsolved",
      disposition == "Closed by arrest" ~ "Resolved"
    )
  ) %>%
  select(city_state, resolved) %>%
  filter(city_state != "Tulsa_AL")
```

    ## Parsed with column specification:
    ## cols(
    ##   uid = col_character(),
    ##   reported_date = col_double(),
    ##   victim_last = col_character(),
    ##   victim_first = col_character(),
    ##   victim_race = col_character(),
    ##   victim_age = col_character(),
    ##   victim_sex = col_character(),
    ##   city = col_character(),
    ##   state = col_character(),
    ##   lat = col_double(),
    ##   lon = col_double(),
    ##   disposition = col_character()
    ## )

``` r
aggregate_df <-
  homicide_df %>%
  group_by(city_state) %>%
  summarize(
    homicide_total = n(),
    homicide_unsolved = sum(resolved == "Unsolved")
  )
```

    ## `summarise()` ungrouping output (override with `.groups` argument)

Can we do a test for proportions for a specific city?

``` r
prop.test(
  aggregate_df %>% filter(city_state=="Baltimore_MD") %>% pull(homicide_unsolved),
  aggregate_df %>% filter(city_state=="Baltimore_MD") %>% pull(homicide_total)) %>%
  broom::tidy()
```

    ## # A tibble: 1 x 8
    ##   estimate statistic  p.value parameter conf.low conf.high method    alternative
    ##      <dbl>     <dbl>    <dbl>     <int>    <dbl>     <dbl> <chr>     <chr>      
    ## 1    0.646      239. 6.46e-54         1    0.628     0.663 1-sample~ two.sided

Iterate:

``` r
prop_results <-
  aggregate_df %>%
  mutate(
    prop_tests = map2(.x = homicide_unsolved, .y = homicide_total,
                      ~prop.test(x = .x, n = .y)),
    tidy_tests = map(.x = prop_tests, ~broom::tidy(.x))
  ) %>%
  select(-prop_tests) %>%
  unnest(tidy_tests) %>% # unpacks the prop.test results as their own columns
  select(city_state, estimate, conf.low, conf.high)

prop_results %>%
  mutate(city_state = fct_reorder(city_state, estimate)) %>%
  ggplot(aes(x = city_state, y = estimate)) +
  geom_point() +
  theme(axis.text.x = element_text(angle = 90, vjust=0.5, hjust=1)) +
  geom_errorbar(aes(ymin=conf.low, ymax=conf.high)) +
  labs(
    title = "Distribution of Homicide Rates",
    x = "Location (City_State)",
    y = "Estimate of Proportion",
    caption = "caption here."
  )
```

<img src="p8105_hw5_sn2863_files/figure-gfm/unnamed-chunk-3-1.png" width="90%" />

### Problem 2 Longitudinal Study

``` r
path_df <- tibble(path = list.files("longitudinal_data")) %>%
  separate(path, c("arm", "subject_id", "file"), convert = TRUE,
           remove = TRUE) %>%
  select(-file) %>%
  mutate(
    path = str_c("longitudinal_data/", list.files("longitudinal_data")),
    data = map(.x = path, ~read_csv(.x))
    ) %>%
  select(-path) %>%
  unnest(data)

tidy_df <-
  path_df %>%
  pivot_longer(week_1:week_8, 
               names_prefix = "week_",
               names_to = "week", 
               values_to = "observation") %>%
  mutate(week = as.numeric(week))
```

After combining all the csv files together and tidying the dataset, we
have 160 observations in our dataset. There are 4 columns including the
arm that the subject is in, the ID of the subject within the arm, and
the week and corresponding observation.

#### Spaghetti plot showing observations over-time

``` r
tidy_df %>%
  ggplot(aes(x=week, y=observation, group=subject_id)) +
  facet_grid(~arm)+
  theme(legend.position = "none") +
  scale_color_manual(values=c("#39568CFF", "#55C667FF")) +
  geom_point(aes(color=arm)) +
  geom_line(aes(color=arm)) +
    labs(
    title = "Spaghetti Plot of Longitudinal Data",
    x = "Week",
    y = "Value in Units of Observation",
    caption = "A two-panel spaghetti plot of observations of each subject from the control and experimental arms over time."
  )
```

<img src="p8105_hw5_sn2863_files/figure-gfm/unnamed-chunk-5-1.png" width="90%" />

Looking at the two panels of the spaghetti plot, we see that the control
group generally has more of a flat trend over the 8 weeks of
observation. The experimental group has an increasing trend in the units
of observation over the 8 weeks of observation. It seems like both
groups start around the same points, so this indicates that the
experimental treatment shows evidence of an effect, whereas the control
group does not. Finally, looking at the general spread of the lines, it
seems like both groups have similar variability among subjects (just
visually speaking, though).

### Problem 3 Simulation

``` r
sim_t <- function(mu){
  sim_data <- tibble(
    tibble(
      true_mu = mu, # decided to have the true mean in the tibble
      x = rerun(50, rnorm(n=30, mean=mu, sd=5))
    )) %>%
  mutate(
    t_tests = map(.x = x, ~t.test(x=.x, mu=0)),
    tidy_t = map(.x = t_tests, ~broom::tidy(.x))
    ) %>%
    select(-t_tests) %>%
unnest(tidy_t) %>%
select(true_mu, estimate, p.value)
}

output <- vector("list", 7)
for (i in 1:7){
  output[[i]] = sim_t(i-1) %>% # for values of mu = 0 to 6
    bind_rows
}


# how can I make these into one big list into one broken up into 7??
# unnest at the end

sim_t2 <- function(mu){
  sim_data <- tibble(
    tibble(
      true_mu = mu, # decided to have the true mean in the tibble
      x = rnorm(n=30, mean=mu, sd=5)
    )) %>%
  mutate(
    t_tests = map(.x = x, ~t.test(x=.x, mu=0)),
    tidy_t = map(.x = t_tests, ~broom::tidy(.x))
    ) %>%
    select(-t_tests)
}

output2 <- vector("list", 7)

sim_res <-
  tibble(true_mu = c(0:6)) %>%
  mutate(
    output_list = map(.x = true_mu, ~rerun(50, sim_t2(mu = .x))),
    estimate_dfs = map(output_list, bind_rows)) %>%
  select(-output_list) %>%
  unnest(estimate_dfs)
```
